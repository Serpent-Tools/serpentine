stable = Image("rust:latest") > WorkingDir("/app");
nightly = Image("rustlang/rust:nightly") > WorkingDir("/app");

def WithSource(container) {
    return container > Copy(".", ".") ;
}

binstall = stable > Exec("cargo install cargo-binstall");

clippy = nightly
    > Exec("rustup component add clippy")
    > WithSource()
    > Exec("cargo clippy -- -Dwarnings");

fmt = nightly
    > Exec("rustup default nightly")
    > Exec("rustup component add rustfmt")
    > WithSource()
    > Exec("cargo fmt --check");

spelling = binstall
    > Exec("cargo binstall typos-cli")
    > WithSource()
    > Exec("typos");

tests = binstall
    > Exec("cargo binstall cargo-nextest")
    > WithSource()
    > Exec("cargo nextest run");

export DEFAULT = !(tests, spelling, clippy, fmt) Noop(0);
