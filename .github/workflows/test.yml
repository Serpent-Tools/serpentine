name: Serpentine Tests
on: [push]
jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e
        with:
            toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
            cache-on-failure: true
      - uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830
        id: cache-restore
        with:
          path: ./serpentine_cache
          key: serpentine_cache-${{ github.sha }}
          restore-keys: serpentine_cache-

      - name: Install deps
        run: sudo apt-get install -y protobuf-compiler

      - name: Install nextets
        run: curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin

      - name: Build container 
        run: docker build -t serpent-tools/containerd:dev . 

      - name: Run tests
        run: cargo nextest run --all-features --fail-fast

      - name: Run serpentine pipeline
        run: cargo run -p serpentine --locked -- run --cache ./serpentine_cache --standalone-cache --clean-old --ci --entry-point FULL --jobs 1 

      - uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830
        if: always()
        with:
          path: ./serpentine_cache
          key: ${{ steps.cache-restore.outputs.cache-primary-key }} 
